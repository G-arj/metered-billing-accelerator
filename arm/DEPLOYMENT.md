# Architecture #

The following picture shows the architecture and network topology of the sample.

![Architecture](../images/infrastructure.png)

The ARM template under the **templates/infra** folder deploys the following resources to the **MeteringInfraRG** resource group:

- A Blob Storage Account with 3 containers:
  - **checkpoints**: this container will host the blobs, one for each Event Hub partition, used by the **Aggregator** Azure Function and in particular by the [EventProcessorClient](https://docs.microsoft.com/en-us/azure/event-hubs/event-hubs-dotnet-standard-getstarted-send) to handle the ownership of the Event Hub partitions using the [Leader Election](https://docs.microsoft.com/en-us/azure/architecture/patterns/leader-election) pattern. For mlore information, see [Balance partition load across multiple instances of your application](https://docs.microsoft.com/en-us/azure/event-hubs/event-processor-balance-partition-load).
  - **snapshots**: this container will used by the **Aggregator** Azure Function to store partial aggregated results.
  - **capture**: this store will be used to capture the streaming data in the **events** Event Hub in the Azure Blob Storage Account. For more information, see [capture the streaming data in Event Hubs in an Azure Blob storage](https://docs.microsoft.com/en-us/azure/event-hubs/event-hubs-capture-overview).
- A Consumption Plan used to host the **Aggregator** Azure Function.
- An Azure Functions App used to run the **Aggregator** Azure Function.
- A Log Analytics workspace used to collect diagnostics logs and metrics from all the Azure services used by the solution.
- An Application Insights used to collect traces and exceptions generated by the **Aggregator** Azure Function.

The ARM template under the **templates/sample** folder deploys the following resources to the **MeteringInfraRG** resource group:

- An Hosting Plan used to host the sample web app
- An App Service in the above hosting plan used to host the sample WebApp

## Deployment ##

You can use the **deploy-infra.sh** script under the **scripts** folder to deploy the infrastructure necessary to run and monitor the solution. The following figure shows the resources deployed by the ARM template in the target resource group.

![Resource Group](../images/infra-resource-group.png)